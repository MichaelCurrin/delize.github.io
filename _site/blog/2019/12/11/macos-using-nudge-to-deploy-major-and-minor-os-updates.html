<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>macOS - Using nudge to deploy major (and minor) OS updates</title>
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="author" content="Andrew Doering" />
<meta name="ROBOTS" content="">
        <!--  FavIcon  -->
<link rel="apple-touch-icon" sizes="180x180" href=/assets/favicon//apple-touch-icon.png >
<link rel="icon" type="image/png" sizes="32x32" href=/assets/favicon//favicon-32x32.png>
<link rel="icon" type="image/png" sizes="16x16" href=/assets/favicon//favicon-16x16.png>
<link rel="manifest" href=/assets/favicon/site.webmanifest>

<!-- Google Fonts -->
<link async rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli:300,400,600%7CPoppins:400,500,600,700" />

<!--  Bootstrap CSS  -->
<!-- <link rel="stylesheet" href=/assets/css/bootstrap.css > -->
<link rel="stylesheet" href=/assets/css/bootstrap.min.css >
<!--  Line Icon CSS  -->
<link rel="stylesheet" href=/assets/css/LineIcons.css>
<!--  Font Awesome CSS  -->
<link async rel="stylesheet" href=/assets/css/all.min.css />
<!-- <link rel="stylesheet" href=/assets/css/font-awesome.min.css> -->
<!--  Animate CSS  -->
<link rel="stylesheet" href=/assets/css/animate.css> 
<!--  Magnific Popup CSS  -->
<link rel="stylesheet" href=/assets/css/magnific-popup.css>
<!--  Owl-carousel CSS  -->
<link rel="stylesheet" href=/assets/css/owl.carousel.min.css>
<!--  Custom Style CSS  -->
<link rel="stylesheet" href=assets/css/style.css>

        <!--  Custom Style CSS  -->
<link rel="stylesheet" href=/assets/css/style-blog.css>
    </head>

    <body data-spy="scroll" data-target="#scrollspy" data-offset="61" class="uone-dark pt-hero">

                <!--  Pre Loader  -->
        <div id="overlayer"></div>
        <span class="loader"></span>
        <!--    Header Start    -->
<header id="header" class="header page-header bg-white fixed-top">
    <nav id="scrollspy" class="navbar navbar-expand-lg header-nav">
        <div class="container">
            <a class="navbar-brand font-weight-bold text-dark" href="http://127.0.0.1:4000">macOS - Using nudge to deploy major (and minor) OS updates</span></a>
            <!--  Navbar Toggler Button Start -->
            <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#toggle-menu" aria-controls="toggle-menu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="lni-menu size-md"></span>
            </button>
            <!--  Navbar Toggler Button End -->
            <div class="collapse navbar-collapse" id="toggle-menu">
                <ul class="navbar-nav nav-pills ml-auto">
                    <li class="nav-item">
                        <a class="nav-link text-dark" onclick="goBack()" href="javascript:void(0)">Back</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<!--    Header End    -->
        <!--    Header End    -->

        <!--    Hero Start    -->
        <section class="hero page-hero py-6" id="hero">
            <div class="text-center hero-content mx-auto">
                <h1 class="text-white mb-4 margin="4 px">macOS - Using nudge to deploy major (and minor) OS updates</h1>
                <p class="mx-auto text-white">
                    <a href="http://127.0.0.1:4000" class="text-white">Home</a>
                    /
                    <a href="http://127.0.0.1:4000/blog" class="text-white">Blog</a>
                    /
                    <span class="text-white">macOS - Using nudge to deploy major (and minor) OS updates</span>
                </p>
            </div>
        </section>
        <!--    Hero End    -->

        <!--   Blog-single   Start -->
        <section class="py-6">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 offset-lg-1 blog">
                        <div class="rounded px-lg-5">
                            <div class="text-md-left">
                                <h4 class="mb-4">macOS - Using nudge to deploy major (and minor) OS updates</h4>
                                <img src="" alt="" class="img-fluid w-100 rounded">
                                <span class="d-inline-block py-4"> 2019-12-11 04:24:00 -0800
                                        / By <span class="purple-color text-right"> Andrew Doering. </span>
                                        </span>
                                <p class="link-"><p>Having users update that do not have administrator permissions in macOS is a pain. Thankfully there is a cool (not new, but not well known) tool out called nudge (by Erik Gomez). You find the tool <a href="https://github.com/erikng/nudge">here on Github</a>.</p>

<p>I will be going over how we are implementing this at ThousandEyes.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>GCP Bucket (because it is free!)</li>
  <li>JSON template</li>
  <li>Software Deployment Tool (JAMF or Munki, we use Munki)</li>
  <li>Catalina Installer (we need to grab the icons from somewhere)</li>
</ul>

<h2 id="lets-get-started">Let’s get started!</h2>

<h3 id="fork-the-github-code-to-your-own-repo">Fork the Github Code to your own repo</h3>

<p>In case something happens to the source, always be sure to fork the repo to your own. You can always pull updates and push into your fork.</p>

<h3 id="examining-the-template-file-and-the-resources-folder">Examining the template file and the resources folder</h3>

<p>Erik was very considerate enough to already provide the template file in the fork, however, there is some modifications to make here.</p>

<p>If we take a look at the fork we will notice a few specific things. Mainly that there is a nice “resources” folder located <a href="https://github.com/erikng/nudge/tree/3901ca478b32a323924f7b443826c4ead61c3a60/payload/Library/Application%20Support/nudge/Resources">here</a>. This means that we can indepently modify both the company logo, as well as the update_ss.png content after deployment without recompiling the entire application. In addition to this, if you look below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;code&gt;{
    "preferences": {
        "button_title_text": "Ready to start the update?",
        "button_sub_titletext": "Click on the button below.",
        "cut_off_date": "2018-12-31-00:00",
        "cut_off_date_warning": 3,
        "days_between_notifications": 0,
        "logo_path": "/path/to/company_logo.png",
        "main_subtitle_text": "A friendly reminder from your local IT team",
        "main_title_text": "macOS Update",
        "minimum_os_version": "10.14.0",
        "more_info_url": "https://google.com",
        "no_timer": false,
        "paragraph1_text": "A fully up-to-date device is required to ensure that IT can your accurately protect your computer.",
        "paragraph2_text": "If you do not update your computer, you may lose access to some items necessary for your day-to-day tasks.",
        "paragraph3_text": "To begin the update, simply click on the button below and follow the provided steps.",
        "paragraph_title_text": "A security update is required on your machine.",
        "path_to_app": "/Applications/Install macOS Mojave.app",
        "screenshot_path": "/path/to/update_ss.png",
        "timer_day_1": 600,
        "timer_day_3": 7200,
        "timer_elapsed": 10,
        "timer_final": 60,
        "timer_initial": 14400,
        "random_delay": false,
        "update_minor": false,
        "update_minor_days": 14
    },
    "software_updates": [{
        "name": "091-22861",
        "force_install_date": "2018-12-31-00:00"
    }]
}&lt;/code&gt;
</code></pre></div></div>

<p>We are also able to specify custom paths for the company logo and the screenshot path. So we don’t necessarily need to constantly replace/overwrite the files listed in here and recompile the application every time a major OS is released.</p>

<p>We can simply modify the config json file, time after time, with changes to:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">screenshot_path</code> - the image that shows in the middle of the nudge UI</li>
  <li><code class="language-plaintext highlighter-rouge">logo_path</code> - the company logo (hopefully this doesn’t change too often)</li>
  <li><code class="language-plaintext highlighter-rouge">more_info_url</code> - the documentation page that you should provide employees about the OS update</li>
  <li><code class="language-plaintext highlighter-rouge">cut_off_date</code> - the deadline you want employees to upgrade by</li>
  <li><code class="language-plaintext highlighter-rouge">minimum_os_version</code> - the minimum MAJOR OS Version that you would like to apply</li>
</ul>

<p>However, within this template we need to make a few more changes.</p>

<p>Everything from <code class="language-plaintext highlighter-rouge">"software_updates": [{</code> to <code class="language-plaintext highlighter-rouge">}]</code> needs to be removed. Also be sure to remove the comma(<code class="language-plaintext highlighter-rouge">,</code>) next to the <code class="language-plaintext highlighter-rouge">}</code>.  This is due to the code changing, and this becoming deprecated in a previous version of the software. We also need to remove the comma since we no longer have a second array in the configuration file.</p>

<p>Now, in addition to the above, we need to add several things depending on your configuration (I assume you are using a management software to roll out the OS upgrade). Platform independent changes are going to be adding a minimum sub os version (<code class="language-plaintext highlighter-rouge">minimum_os_sub_build_version</code>) and a value (in our case we used <code class="language-plaintext highlighter-rouge">19B88</code> - based on the sub build version from <a href="https://developer.apple.com/news/releases/?id=10292019c">here</a>).</p>

<h4 id="jamf-specific-configuration">JAMF specific configuration</h4>

<p>I just want to be clear, we don’t use JAMF at ThousandEyes, so this configuration may be wrong - I am basing the information here on the readme.md file, as well as general knowledge of what I can find in the JAMF’s documentation.</p>

<p>If you would like users to launch the UI page in the Jamf Self Service tool, for them to perform the upgrade at a conveient time:<br />
<code class="language-plaintext highlighter-rouge">"local_url_to_upgrade": " jamfselfservice://content?entity=policy&amp;id=&lt;id&gt;&amp;action=view </code></p>

<p>If you would like users to automatically initiate the upgrade as soon as they hit the button:<br />
<code class="language-plaintext highlighter-rouge">"local_url_to_upgrade": " jamfselfservice://content?entity=policy&amp;id=&lt;id&gt;&amp;action=execute "</code></p>

<p>Now with both of the methods above, you would need to replace the <code class="language-plaintext highlighter-rouge">&lt;id&gt;</code> with the actual ID of the policy. Since we don’t run JAMF at ThousandEyes, not sure if this is a numeric value or a string.</p>

<h4 id="munki-specific-configuration">Munki specific configuration</h4>

<p>We do however, use Munki at ThousandEyes. So I can give you a more specific/detailed explanation here. Unfortunately, what we are doing here is very straight forward. As ThousandEyes</p>

<h4 id="thousandeyes-example-template">ThousandEyes Example Template</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;code&gt;{
    "preferences": {
        "button_title_text": "Ready to start the update?",
        "button_sub_titletext": "Click on the button below.",
        "cut_off_date": "2020-1-15-00:00",
        "cut_off_date_warning": 20,
        "days_between_notifications": 0,
        "logo_path": "/Library/Application Support/nudge/Resources/company_logo.png",
        "main_subtitle_text": "A friendly reminder from your local IT team",
        "main_title_text": "macOS Update",
        "minimum_os_version": "10.15.1",
        "minimum_os_sub_build_version": "19B88",
        "more_info_url": "https://knowledgebase.documentation.com",
        "no_timer": false,
        "paragraph1_text": "A fully up-to-date device is required to ensure that IT can your accurately protect your computer.",
        "paragraph2_text": "If you do not update your computer, you may lose access to some items necessary for your day-to-day tasks.",
        "paragraph3_text": "To begin the update, simply click on the button below and follow the provided steps.",
        "paragraph_title_text": "A security update is required on your machine.",
        "path_to_app": "/Applications/Install macOS Catalina.app",
        "screenshot_path": "/Library/Application Support/nudge/Resources/update_stg.png",
        "timer_day_1": 600,
        "timer_day_3": 3600,
        "timer_elapsed": 10,
        "timer_final": 300,
        "timer_initial": 14400,
        "random_delay": false,
        "update_minor": true,
        "update_minor_days": 14,
        "local_url_for_upgrade": "munki://detail-Install_macOS_Catalina"
    }
  }
&lt;/code&gt;
</code></pre></div></div>

<p>I left the defaults for some of the content, as to be honest, I don’t know if I could come up with any better wording. However, I did change the timer numbers - I want to maximize the amount of popups but without the too much annoyance. If we leave too much a gap, users will just ignore it.</p>

<p>Omitting our own knowledgebase article url, include yours. Ours is quite slim, as this tool has made it far easier to upgrade.</p>

<p>While <code class="language-plaintext highlighter-rouge">path_to_upgrade</code> should/would be ignored since we are using <code class="language-plaintext highlighter-rouge">local_url_for_upgrade</code>, we left it in as a backup in case.</p>

<p><code class="language-plaintext highlighter-rouge">local_url_for_upgrade</code> is pointing directly to our Catalina installation. If you don’t modify the contents when using <code class="language-plaintext highlighter-rouge">munkiimport</code> this should make perfect sense as to why we used “Install_macOS_Catalina” (it’s the default on importing). Within munki, we setup our pre-requisites to require our AntiVirus software prior to installation of Catalina. The reason for this is that in the past Kernel Panics have been a problem. Because of this, we prefer to setup the latest version of the AV as a pre-req.</p>

<p><code class="language-plaintext highlighter-rouge">minimum_os_sub_build_version</code> if this is not included you end up running into this <a href="https://github.com/erikng/nudge/issues/24">bug</a>. This key is required (as of now).</p>

<p>Now let’s move on to the LaunchAgent configuration.</p>

<h3 id="nudge-launchagent">nudge LaunchAgent</h3>

<p><a href="https://github.com/erikng/nudge/blob/3901ca478b32a323924f7b443826c4ead61c3a60/payload/Library/LaunchAgents/com.erikng.nudge.plist">https://github.com/erikng/nudge/blob/3901ca478b32a323924f7b443826c4ead61c3a60/payload/Library/LaunchAgents/com.erikng.nudge.plist</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;code&gt;&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
	&lt;key&gt;Label&lt;/key&gt;
	&lt;string&gt;com.erikng.nudge&lt;/string&gt;
	&lt;key&gt;LimitLoadToSessionType&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;Aqua&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;/Library/Application Support/nudge/Resources/nudge&lt;/string&gt;
		&lt;string&gt;--jsonurl=https://fake.domain.com/path/to/config.json&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;RunAtLoad&lt;/key&gt;
	&lt;true/&gt;
	&lt;key&gt;StandardOutPath&lt;/key&gt;
	&lt;string&gt;/Library/Application Support/nudge/Logs/nudge.log&lt;/string&gt;
	&lt;key&gt;StandardErrorPath&lt;/key&gt;
	&lt;string&gt;/Library/Application Support/nudge/Logs/nudge.log&lt;/string&gt;
	&lt;key&gt;StartCalendarInterval&lt;/key&gt;
	&lt;array&gt;
		&lt;dict&gt;
			&lt;key&gt;Minute&lt;/key&gt;
			&lt;integer&gt;0&lt;/integer&gt;
		&lt;/dict&gt;
		&lt;dict&gt;
			&lt;key&gt;Minute&lt;/key&gt;
			&lt;integer&gt;30&lt;/integer&gt;
		&lt;/dict&gt;
	&lt;/array&gt;
&lt;/dict&gt;
&lt;/plist&gt;&lt;/code&gt;
</code></pre></div></div>

<p>In addition to this, there are some personal recommendations I would make for this based on feedback we had from our employees (they were pissed on our initial roll out of <a href="https://github.com/erikng/umad">UMAD</a>). While I agree that on the 0 and 30 (every half hour) is a good plan, unfortunately, our company is small enough that I will get complaints and an ear full. Because of this,</p>

<p>Now, if you remember that config.json file from earlier, and you notice that default option here is <code class="language-plaintext highlighter-rouge">--jsonurl=</code> you might see where this is headed. Making an updatable and flexible preferences file to load into nudge (while also allowing for flexible image locations as well).</p>

<h3 id="using-gcp">Using GCP</h3>

<p>Google Cloud Platform has a <a href="https://cloud.google.com/free/">free tier</a> for 5GB storage buckets. This <em>may</em> not work well for you if you have over 10000 employees all hitting the service at the same time over a month or more of time. As the limitations of GCP Free tier are outlined below (as of 2019/12/02)</p>

<ul>
  <li>5 GB-months of regional storage (US regions only)</li>
  <li>5,000 Class A Operations per month</li>
  <li>50,000 Class B Operations per month</li>
  <li>1 GB network egress from North America to all region destinations (excluding China and Australia) per month</li>
</ul>

<p>The definition of the “classes” can be found <a href="https://cloud.google.com/storage/pricing#operations-pricing">here</a>. However for our needs, this works fine. The service is cheap enough, the operating costs are minimal, and it just works for our service.</p>

<p>S3 would also be an alternative here as well, we just did not use it at ThousandEyes internally for IT.</p>

<p>We will be granting access based on permissions here: https://cloud.google.com/storage/docs/access-control/lists#scopes<br />
Since there is nothing private or personal here, and google defaults to HTTPS sites with no authentication it works great for our usecase.</p>

<p>To do this, create a storage bucket, call it something relevant to you, we called ours <code class="language-plaintext highlighter-rouge">nudge-os-release-notification</code> and then place your config.json file in the bucket. Once you create this bucket, while you could and should have this authenticated, the easiest way for you to begin testing is to set the member <code class="language-plaintext highlighter-rouge">allUsers</code> to the <code class="language-plaintext highlighter-rouge">Storage Object Viewer</code> role, this creates a public bucket, where anyone could download the contents of the files within the bucket. Not great for production, but perfectly fine for one-off testing.</p>

<h3 id="stg--prod">STG &amp; PROD</h3>

<p>What happens if we want to test deployment of a minor OS Update. We have a stg and production version of this application, where we apply the production version to all machines, and then apply stg to specific ones. This is not revolutionary in anyway.</p>

<h2 id="ways-to-improve-this">Ways to improve this</h2>

<p>While we have only implemented an initial version of this software:</p>

<ul>
  <li>Instead of placing the file (either the logo, or the download icon) on the machine, why not allow them to be displayed on demand (similar to the json file, grab them from the internet and then keep them in a cache location). Then remove after use (or upgrade). This allows us to be flexible enough with the files, while still not having to redistribute the original nudge package (or single file packages) for every OS Upgrade revision.</li>
</ul>

<h2 id="major-thanks-to-erik">Major thanks to Erik</h2>

<p>I want to give a major thanks to Erik, ThousandEyes IT has been using several of the tools he has developed over the past few years and it has made our job much easier, allowing us to develop and work on other things that pop up within the company.</p>

</p>
                                
                                <div id="disqus_thread"></div>
<script>

var disqus_config = function () {
this.page.url = "https://andrewdoering.org/blog/2019/12/10/macos-using-nudge-to-deploy-major-and-minor-os-updates/";  
this.page.identifier = "macos-using-nudge-to-deploy-major-and-minor-os-updates"; 
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://andrewdoering-org.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                
        </section>
        
        <!--   Blog-Single End  -->


        <!--   Footer Start  -->
<footer class="bg-dark">
    <div class="container">
        <div class="row py-5">
            <div class="col-lg-4">
                <h4 class="text-white mt-3 mt-lg-0">About <span class="base-color"> Me</span></h4>
                <p class="text-white pt-3 mb-0">Andrew Doering resides in San Francisco, and currently maintains a position at
                    ThousandEyes as a Senior IT Engineer. </p>
            </div>
            <div class="col-lg-4">
                <h4 class="text-white mt-3 mt-lg-0">Contact <span class="base-color">Us</span></h4>
                <ul class="list-unstyled text-white pt-2 mb-0">
                    <li class="py-1"><i class="fas fa-map-marker-alt pr-2"></i> San Francisco, CA 94109 USA</li>
                    <li class="py-1"><i class="fas fa-phone-square-alt pr-2"></i><a href="tel:+1 919-904-4396"> +1 919 904 4396</a></li>
                    <li class="py-1"><i class="fas fa-envelope pr-2"></i><a href="mailto:contact@andrewdoering">
                            contact@andrewdoering.org</a></li>
                </ul>
            </div>
            <div class="col-lg-4">
                <h4 class="text-white mt-3 mt-lg-0">My <span class="base-color">Socials</span></h4>
                <ul class="list-unstyled text-white socials pt-2 mb-0">
                    <li class="py-1"><a class="text-white link-hover" href="https://www.facebook.com/and.doe"><i class="fab fa-facebook-f pr-2" aria-hidden="true"></i>
                            Facebook</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.linkedin.com/in/andrewdoering"><i class="fab fa-linkedin pr-2"
                                aria-hidden="true"></i> LinkedIn</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.github.com/delize"><i class="fab fa-github pr-1" aria-hidden="true"></i>
                            Github</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.instagram.com/dolos01"><i class="fab fa-instagram pr-2" aria-hidden="true"></i>
                            Instagram</a></li>
                    <li class="py-1"><a class="text-white link-hover" href="skype:andrew-doering"><i class="fab fa-skype pr-2" aria-hidden="true"></i> andrew-doering</a>
                    </li>
                    <li class="py-1"><a class="text-white link-hover" href="https://www.macadmins.org/"><i class="fab fa-slack pr-2" aria-hidden="true"></i> @heimdall</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 border-top pb-5">
                <p class="mt-3 mb-0 text-white d-lg-inline-block text-center">Copyright © 2020</p>
                <a href="javascript:void(0);" class="mt-4 mt-lg-3 mb-0 text-white back-to-top d-block d-lg-inline-block float-lg-right text-center">Back To Top</a>
            </div>
        </div>
    </div>
</footer>
<!--   Footer End  -->
        <!--  JavaScripts  -->
<script src=/assets/js/jquery-3.4.1.min.js></script>
<!--  Bootstrap Js  -->
<!-- <script src="assets/js/bootstrap.js"></script> -->
<script src=/assets/js/bootstrap.min.js></script>
<!--  Easing Js  -->
<script src=/assets/js/jquery.easing.min.js></script>
<!--  Isotope Js  -->
<script src=/assets/js/slyslider.js></script>
<!--  Pop UP JS Js  -->
<script src=/assets/js/jquery.magnific-popup.min.js></script>
<!--  Owl carousel Js  -->
<script src=/assets/js/owl.carousel.min.js></script>
<!--  Wow Js  -->
<script src=/assets/js/wow.min.js></script>
<!--  Typed Js  -->
<script src=/assets/js/typed.js></script>
<!--  Custom JS  -->
<script src=/assets/js/uone.js></script>


    </body>
</html>